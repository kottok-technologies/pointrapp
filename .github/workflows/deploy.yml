name: Deploy PointrApp

on:
  push:
    branches:
      - main
      - dev

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy with Docker and Terraform
    runs-on: ubuntu-latest
    environment: >
      ${{
        github.ref == 'refs/heads/main' && 'Prod' ||
        'Dev'
      }}
    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPO: "pointrapp"
      TERRAFORM_DIR: "terraform"
      WORKSPACE: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
      # üß© Step 0: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # üîê Step 1: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # üß± Step 2: Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # üåç Step 3: Terraform init
      - name: Terraform Init
        run: terraform -chdir=${{ env.TERRAFORM_DIR }} init

        # üß© Step 4: Build our Lambda packages
      - name: Package Lambda Functions
        run: |
          chmod +x scripts/package_lambdas.sh
          ./scripts/package_lambdas.sh
          echo "üìÇ Verifying built Lambda packages..."
          ls -lah terraform/modules/infra/lambdas/dist

      # üß∞ Step 5: Create or ensure global ECR (only once)
      - name: Terraform Apply Global ECR
        run: |
          terraform -chdir=${{ env.TERRAFORM_DIR }} apply \
            -auto-approve \
            -target=module.ecr

      # üîë Step 6: Login to ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
          docker login --username AWS --password-stdin \
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

      # üîë Step 7: Build env file
      - name: Generate .env.production
        run: |
          chmod +x scripts/generate_env.sh
          ./scripts/generate_env.sh

      # üê≥ Step 8: Build & Push Docker Image
      - name: Build and Push Docker Image
        run: |
          IMAGE_URI=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "image_uri=$IMAGE_URI" >> $GITHUB_ENV

      # üèóÔ∏è Step 9: Select or create Terraform workspace
      - name: Select Terraform workspace
        run: |
          terraform -chdir=${{ env.TERRAFORM_DIR }} workspace select $WORKSPACE || \
          terraform -chdir=${{ env.TERRAFORM_DIR }} workspace new $WORKSPACE
          echo "Using Terraform workspace: $WORKSPACE"

      # ‚öôÔ∏è Step 10: Terraform Apply (App + DynamoDB)
      - name: Terraform Apply Environment Infra
        run: |
          terraform -chdir=${{ env.TERRAFORM_DIR }} apply -auto-approve \
            -var="image_uri=${{ env.image_uri }}" \
            -var="environment=${{ env.WORKSPACE }}" \
            -target=module.infra

      # üíæ Step 11: Capture Terraform Outputs for DNS + Certificate
      - name: Capture Terraform Outputs
        run: |
          terraform -chdir=${{ env.TERRAFORM_DIR }} output -json > tf_outputs.json
          cat tf_outputs.json
          echo "dns_target=$(jq -r '.dns_target.value' tf_outputs.json)" >> $GITHUB_ENV
          echo "certificate_validation_records=$(jq -c '.certificate_validation_records.value // []' tf_outputs.json)" >> $GITHUB_ENV
          echo "‚úÖ Captured dns_target: $dns_target"
          echo "‚úÖ Captured certificate_validation_records"

      # ‚öôÔ∏è Step 12: Terraform Apply (Route53)
      - name: Terraform Apply Route53
        run: |
          terraform -chdir=${{ env.TERRAFORM_DIR }} apply -auto-approve \
            -var="dns_target=${{ env.dns_target }}" \
            -var='certificate_validation_records=${{ env.certificate_validation_records }}' \
            -var="environment=${{ env.WORKSPACE }}" \
            -target=module.route53

      # üïê Step 13: Wait for App Runner Certificate Validation
      - name: Wait for App Runner Certificate Validation
        run: |
          echo "üïê Waiting for App Runner certificate validation..."
          # Determine domain based on environment
          if [ "${{ env.WORKSPACE }}" = "prod" ]; then
            DOMAIN_NAME="www.pointrapp.com"
          else
            DOMAIN_NAME="dev.pointrapp.com"
          fi

          # Get App Runner service ARN from Terraform outputs
          SERVICE_ARN=$(terraform -chdir=${{ env.TERRAFORM_DIR }} output -raw service_arn 2>/dev/null || echo "")
          if [ -z "$SERVICE_ARN" ]; then
            echo "‚ùå Could not fetch service ARN from Terraform outputs."
            exit 1
          fi
          echo "üì¶ Service ARN: $SERVICE_ARN"
          echo "üåê Domain: $DOMAIN_NAME"

          # Poll for validation
          for i in {1..30}; do
            STATUS=$(aws apprunner describe-custom-domain-association \
              --service-arn "$SERVICE_ARN" \
              --domain-name "$DOMAIN_NAME" \
              --region ${{ env.AWS_REGION }} \
              --query "CustomDomain.AssociationStatus" \
              --output text 2>/dev/null || echo "UNKNOWN")

            echo "   ‚Üí Attempt $i: Status = $STATUS"
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "‚úÖ Certificate validated successfully!"
              exit 0
            fi
            if [ "$STATUS" = "FAILED" ]; then
              echo "‚ùå Validation failed!"
              exit 1
            fi
            sleep 10
          done

          echo "‚ùå Timeout waiting for certificate validation after 5 minutes."
          exit 1
